{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 30px; text-align: center;">‚ö° Army List Parser</h2>
    
    <form id="parseForm" style="margin-bottom: 30px;">
        <div style="margin-bottom: 20px;">
            <label for="army_text" style="display: block; margin-bottom: 10px; font-weight: bold;">
                üìù Paste your army list here:
            </label>
            <textarea 
                id="army_text" 
                name="army_text" 
                rows="15" 
                placeholder="Example:

Adeptus Custodes
Strike Force (2000 points)
Shield Host

CHARACTERS

Blade Champion (135 points)
‚Ä¢ Warlord
‚Ä¢ 1x Vaultswords
‚Ä¢ Enhancement: Auric Mantle

BATTLELINE

Custodian Guard (170 points)
‚Ä¢ 4x Custodian Guard
‚Ä¢ 2x Guardian spear
‚Ä¢ 1x Misericordia
‚Ä¢ 2x Praesidium Shield
‚Ä¢ 1x Sentinel blade
‚Ä¢ 1x Vexilla"
                style="width: 100%; padding: 15px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(0, 0, 0, 0.3); color: white; font-family: monospace; font-size: 14px; resize: vertical; min-height: 300px;"
                required></textarea>
        </div>
        
        <div style="text-align: center;">
            <button type="submit" class="btn" style="font-size: 18px; padding: 15px 30px;">
                üöÄ Parse Army List
            </button>
        </div>
    </form>
    
    <div id="loading" style="display: none; text-align: center; margin: 20px 0;">
        <div style="font-size: 2rem; margin-bottom: 10px;">‚öôÔ∏è</div>
        <p>Parsing your army list...</p>
    </div>
    
    <div id="error" style="display: none; background: rgba(255, 0, 0, 0.2); border: 1px solid rgba(255, 0, 0, 0.5); border-radius: 8px; padding: 20px; margin: 20px 0;">
        <h3 style="margin-bottom: 10px; color: #ff6b6b;">‚ùå Error</h3>
        <p id="error-message"></p>
    </div>
    
    <div id="results" style="display: none;">
        <h3 style="margin-bottom: 20px;">üìä Parsed Results</h3>
        
        <div id="faction-info" style="background: rgba(255, 215, 0, 0.1); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
            <h4 style="margin-bottom: 15px; color: #ffd700;">üèõÔ∏è Faction Information</h4>
            <div id="faction-details"></div>
        </div>
        
        <div id="units-info">
            <h4 style="margin-bottom: 15px; color: #ffd700;">‚öîÔ∏è Units</h4>
            <div id="units-list"></div>
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
            <button id="copyJson" class="btn" style="margin-right: 10px;">üìã Copy JSON</button>
            <button id="downloadJson" class="btn">üíæ Download JSON</button>
        </div>
        
        <div style="margin-top: 20px;">
            <h4 style="margin-bottom: 15px;">üîß JSON Output</h4>
            <pre id="json-output" style="background: rgba(0, 0, 0, 0.5); padding: 20px; border-radius: 8px; overflow-x: auto; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap; border: 1px solid rgba(255, 255, 255, 0.3);"></pre>
        </div>
    </div>
</div>

<div class="card">
    <h3 style="margin-bottom: 20px;">üí° Tips for Best Results</h3>
    <ul style="list-style-position: inside; line-height: 1.6;">
        <li style="margin-bottom: 10px;">Include faction name at the top of your list</li>
        <li style="margin-bottom: 10px;">Keep unit names as they appear in official sources</li>
        <li style="margin-bottom: 10px;">Include point costs in parentheses: "Unit Name (120 points)"</li>
        <li style="margin-bottom: 10px;">Use section headers like "CHARACTERS", "BATTLELINE", etc.</li>
        <li style="margin-bottom: 10px;">Mark warlord with "‚Ä¢ Warlord" and enhancements with "‚Ä¢ Enhancement:"</li>
    </ul>
</div>

<script>
document.getElementById('parseForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const armyText = document.getElementById('army_text').value;
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const resultsDiv = document.getElementById('results');
    
    // Show loading, hide results and errors
    loadingDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    resultsDiv.style.display = 'none';
    
    try {
        const response = await fetch('/api/v1/parse/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                army_text: armyText
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Hide loading
        loadingDiv.style.display = 'none';
        
        // Display faction info
        const factionDetails = document.getElementById('faction-details');
        factionDetails.innerHTML = `
            <p><strong>Name:</strong> ${data.faction.name}</p>
            <p><strong>Points:</strong> ${data.faction.points}</p>
            <p><strong>Detachment:</strong> ${data.faction.detachment || 'N/A'}</p>
        `;
        
        // Display units
        const unitsList = document.getElementById('units-list');
        const unitsHtml = Object.entries(data.units).map(([unitId, unit]) => {
            // Format weapons into tables
            const rangedWeapons = unit.meta.weapons ? unit.meta.weapons.filter(w => w.type === 'Ranged') : [];
            const meleeWeapons = unit.meta.weapons ? unit.meta.weapons.filter(w => w.type === 'Melee') : [];
            
            const rangedWeaponsHtml = rangedWeapons.length > 0 ? `
                <div style="margin-top: 15px;">
                    <strong style="color: #87CEEB;">üì´ Ranged Weapons:</strong>
                    <table style="width: 100%; margin-top: 8px; font-size: 0.85em; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
                                <th style="text-align: left; padding: 4px;">Weapon</th>
                                <th style="text-align: center; padding: 4px;">Range</th>
                                <th style="text-align: center; padding: 4px;">A</th>
                                <th style="text-align: center; padding: 4px;">BS</th>
                                <th style="text-align: center; padding: 4px;">S</th>
                                <th style="text-align: center; padding: 4px;">AP</th>
                                <th style="text-align: center; padding: 4px;">D</th>
                                <th style="text-align: left; padding: 4px;">Abilities</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rangedWeapons.map(w => `
                                <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                    <td style="padding: 4px;">${w.name}</td>
                                    <td style="text-align: center; padding: 4px;">${w.range}"</td>
                                    <td style="text-align: center; padding: 4px;">${w.attacks || '-'}</td>
                                    <td style="text-align: center; padding: 4px;">${w.ballistic_skill || '-'}+</td>
                                    <td style="text-align: center; padding: 4px;">${w.strength || '-'}</td>
                                    <td style="text-align: center; padding: 4px;">${w.ap || '0'}</td>
                                    <td style="text-align: center; padding: 4px;">${w.damage || '-'}</td>
                                    <td style="padding: 4px; font-size: 0.8em; opacity: 0.8;">${w.special_rules || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : '';
            
            const meleeWeaponsHtml = meleeWeapons.length > 0 ? `
                <div style="margin-top: 15px;">
                    <strong style="color: #FFB6C1;">‚öîÔ∏è Melee Weapons:</strong>
                    <table style="width: 100%; margin-top: 8px; font-size: 0.85em; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
                                <th style="text-align: left; padding: 4px;">Weapon</th>
                                <th style="text-align: center; padding: 4px;">Range</th>
                                <th style="text-align: center; padding: 4px;">A</th>
                                <th style="text-align: center; padding: 4px;">WS</th>
                                <th style="text-align: center; padding: 4px;">S</th>
                                <th style="text-align: center; padding: 4px;">AP</th>
                                <th style="text-align: center; padding: 4px;">D</th>
                                <th style="text-align: left; padding: 4px;">Abilities</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${meleeWeapons.map(w => `
                                <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                    <td style="padding: 4px;">${w.name}</td>
                                    <td style="text-align: center; padding: 4px;">Melee</td>
                                    <td style="text-align: center; padding: 4px;">${w.attacks || '-'}</td>
                                    <td style="text-align: center; padding: 4px;">${w.weapon_skill || '-'}+</td>
                                    <td style="text-align: center; padding: 4px;">${w.strength || '-'}</td>
                                    <td style="text-align: center; padding: 4px;">${w.ap || '0'}</td>
                                    <td style="text-align: center; padding: 4px;">${w.damage || '-'}</td>
                                    <td style="padding: 4px; font-size: 0.8em; opacity: 0.8;">${w.special_rules || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : '';
            
            return `
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <h5 style="margin-bottom: 10px; color: #ffd700;">${unit.meta.name} (${unit.meta.points} pts)</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <p><strong>Models:</strong> ${unit.models.length}</p>
                            ${unit.meta.is_warlord ? '<p><strong>üèÜ Warlord</strong></p>' : ''}
                        </div>
                        <div>
                            <p><strong>Keywords:</strong> <span style="font-size: 0.85em;">${unit.meta.keywords.join(', ')}</span></p>
                            ${unit.meta.enhancements.length > 0 ? `<p><strong>Enhancements:</strong> ${unit.meta.enhancements.join(', ')}</p>` : ''}
                        </div>
                    </div>
                    ${unit.meta.wargear.length > 0 ? `<p><strong>Selected Wargear:</strong> ${unit.meta.wargear.join(', ')}</p>` : ''}
                    <div style="margin-top: 10px; padding: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 4px;">
                        <strong>Unit Stats:</strong> 
                        <span style="font-family: monospace;">
                            M${unit.meta.stats.move}" | T${unit.meta.stats.toughness} | Sv${unit.meta.stats.save}+ | W${unit.meta.stats.wounds} | Ld${unit.meta.stats.leadership}+ | OC${unit.meta.stats.objective_control}
                        </span>
                    </div>
                    ${rangedWeaponsHtml}
                    ${meleeWeaponsHtml}
                    
                    <!-- Unit Composition -->
                    ${unit.meta.unit_composition && unit.meta.unit_composition.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <strong style="color: #90EE90;">üìã Unit Composition:</strong>
                            <ul style="margin: 8px 0 0 20px; font-size: 0.9em;">
                                ${unit.meta.unit_composition.map(comp => `
                                    <li style="margin-bottom: 4px;">${comp.description}</li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <!-- Abilities -->
                    ${unit.meta.abilities && unit.meta.abilities.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <strong style="color: #DDA0DD;">‚ú® Abilities:</strong>
                            <div style="margin-top: 8px;">
                                ${unit.meta.abilities.map(ability => `
                                    <div style="background: rgba(221, 160, 221, 0.1); border-left: 3px solid #DDA0DD; padding: 8px; margin-bottom: 8px; border-radius: 4px;">
                                        <strong>${ability.name}</strong>
                                        ${ability.type && ability.type !== 'Passive' ? `<span style="font-size: 0.8em; opacity: 0.8;"> (${ability.type})</span>` : ''}
                                        ${ability.description ? `<div style="margin-top: 4px; font-size: 0.9em;">${ability.description}</div>` : ''}
                                        ${ability.parameter ? `<div style="margin-top: 2px; font-size: 0.8em; font-style: italic;">${ability.parameter}</div>` : ''}
                                        ${ability.model ? `<div style="margin-top: 2px; font-size: 0.8em; color: #ffd700;">Model: ${ability.model}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
        unitsList.innerHTML = unitsHtml;
        
        // Display JSON
        const jsonOutput = document.getElementById('json-output');
        jsonOutput.textContent = JSON.stringify(data, null, 2);
        
        // Store data for copy/download
        window.lastParseResult = data;
        
        // Show results
        resultsDiv.style.display = 'block';
        
    } catch (error) {
        console.error('Error:', error);
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
        document.getElementById('error-message').textContent = error.message;
    }
});

// Copy JSON functionality
document.getElementById('copyJson').addEventListener('click', function() {
    const jsonText = JSON.stringify(window.lastParseResult, null, 2);
    navigator.clipboard.writeText(jsonText).then(function() {
        const btn = document.getElementById('copyJson');
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        setTimeout(() => {
            btn.textContent = originalText;
        }, 2000);
    });
});

// Download JSON functionality
document.getElementById('downloadJson').addEventListener('click', function() {
    const jsonText = JSON.stringify(window.lastParseResult, null, 2);
    const blob = new Blob([jsonText], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `army_list_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});
</script>
{% endblock %}